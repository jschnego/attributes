<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Hello Vue Research</title>
    <script src="../static/lib/vue.js"></script>
    <script src="../static/lib/vueperslides.js"></script>
    <link href="../static/css/vueperslides.css" rel="stylesheet">
    <link rel="stylesheet" href="../static/css/style.css">
</head>

<body>
    <div id="app" class="centered">
        <button id="german" class="flag" @click="toGerman"></button>
        <button id="english" class="flag" @click="toEnglish"></button>
        <vueper-slides init-slide="1" ref="slides" class="no-shadow" fractions :disable-arrows-on-edges="true"
            :touchable="false" :fixed-height="'100%'" :bullets="false" @ready="wrapArrow" @slide="nextSlide"
            @input.native="validate">
            <vueper-slide :key="'intro'">
                <template v-slot:content>
                    <div class="vueperslide__content-wrapper">
                        <div class="vueperslide__title">
                            <h1>{{ language.intro }}</h1>
                        </div>
                        <div class="vueperslide__content">
                            <p>{{ language.introThanks }}</p>
                            <p>{{ language.following }}</p>
                            <p>{{ language.protection }}</p>
                            <p id="consent"><input type="checkbox" /> {{ language.consent }}</p>
                        </div>
                    </div>
                </template>
            </vueper-slide>
            <vueper-slide :key="'basic'">
                <template v-slot:content>
                    <div class="vueperslide__content-wrapper">
                        <div class="vueperslide__title">
                            <h1>{{ language.basic }}</h1>
                        </div>
                        <div class="vueperslide__content">
                            <personal-form :language="language" @update="updatePersonal"></personal-form>
                        </div>
                    </div>
                </template>
            </vueper-slide>
            <vueper-slide :key="'exp-intro'">
                <template v-slot:content>
                    <div class="vueperslide__content-wrapper">
                        <div class="vueperslide__title">
                            <h1>Experiment</h1>
                        </div>
                        <div class="vueperslide__content">
                            <p>{{ language.experimentIntro }}</p>
                        </div>
                    </div>
                </template>
            </vueper-slide>
            <vueper-slide v-for="i in 12" :key="'number-' + i">
                <template v-slot:content>
                    <div class="vueperslide__content-wrapper">
                        <div class="vueperslide__title">
                            <h1>#{{ i }}</h1>
                        </div>
                        <div class="vueperslide__content">
                            <p class="centered-text">{{ language.listen }}</p>
                            <div class="audio-container">
                                <audio controls>
                                    <source :src="`../static/audio/recording_${i}.mp3`" type="audio/mpeg">
                                </audio>
                            </div>
                            <p class="centered-text question">{{ language.proficiency }}</p>
                            <likert :left="language.beginner" :right="language.native" :attribute="'proficiency-' + i"
                                @new-eval="updateEvals"></likert>
                            <p class="centered-text question">{{ language.sound }}</p>
                            <div class="evaluations">
                                <div class="left-column column">
                                    <likert left="bad" right="good" :attribute="'quality-' + i" @new-eval="updateEvals">
                                    </likert>
                                    <likert left="Little" right="Much" :attribute="'quantity-' + i"
                                        @new-eval="updateEvals"></likert>
                                    <likert left="Low" right="High" :attribute="'height-' + i" @new-eval="updateEvals">
                                    </likert>
                                </div>
                                <div class="right-column column">
                                    <likert left="Uneducated" right="Educated" :attribute="'education-' + i"
                                        @new-eval="updateEvals"></likert>
                                    <likert left="Harsh" right="Soft" :attribute="'sound-' + i" @new-eval="updateEvals">
                                    </likert>
                                    <likert left="Clumsy" right="Eloquent" :attribute="'eloquence-' + i"
                                        @new-eval="updateEvals"></likert>
                                </div>
                            </div>
                        </div>
                </template>
            </vueper-slide>
            <vueper-slide :key="'conclusion'">
                <template v-slot:content>
                    <div class="vueperslide__content-wrapper">
                        <div class="vueperslide__title">
                            <h1>{{ language.conclusion }}</h1>
                        </div>
                        <div class="vueperslide__content">
                            <p>{{ language.conclusionThanks }} </p>
                            <p>{{ language.concludingQuestion }}</p>
                        </div>
                        <estimation @estimation="updateEstimation"></estimation>
                        <input type="button" :value="language.submit" id="submit" @click="submit"
                            :disabled="!hasEstimated()" />
                    </div>
                </template>
            </vueper-slide>
            <vueper-slide :key="'disclosure'">
                <template v-slot:content>
                    <div class="vueperslide__content-wrapper">
                        <div class="vueperslide__title">
                            <h1>{{ language.disclosure }}</h1>
                        </div>
                        <div class="vueperslide__content">
                            <p>{{ language.conclusionThanks }} </p>
                        </div>
                    </div>
                </template>
            </vueper-slide>
        </vueper-slides>
    </div>
</body>
<script>
    Vue.component('estimation', {
        data: function () {
            return {
                estimation: null
            }
        },
        watch: {
            estimation: function (n, o) {
                let est = {}
                est['estimation'] = n;
                this.$emit('estimation', JSON.stringify(est));
            }
        },
        template: `<input type = "text" id="estimate" v-model="estimation"></input>`
    })

    Vue.component('personal-form', {
        data: function () {
            return {
                personal: {
                    age: null,
                    primary: null,
                    profession: null,
                    contact: null,
                }
            }
        },
        props: ['language'],
        methods: {
            updateData: function () {
                this.$emit('update', JSON.stringify(this.personal));
            }
        },
        template: `
                <div @input="updateData">
                    <span>{{personal}}</span>
                    <p>{{ language.basicIntro }}</p>
                    <label for="age" class="basic-label centered">{{ language.age }}</label>
                    <input type="text" id="age" class="centered" v-model="personal.age"/>
                    <label for="primary" class="basic-label centered">{{ language.primary }}</label>
                    <input type="text" id="primary" class="centered" v-model="personal.primary"/>
                    <label for="profession" class="basic-label centered">{{ language.profession }}</label>
                    <input type="text" id="profession" class="centered" v-model="personal.profession"/>
                    <label for="contact" class="basic-label centered">{{ language.contact }}</label>
                    <input type="text" id="contact" class="centered" v-model="personal.contact"/>
                </div>
        `
    });

    Vue.component('likert', {
        data: function () {
            return {
                selected: null
            }
        },
        props: ['left', 'right', 'attribute'],
        watch: {
            selected: function (n, o) {
                let eval = {}
                eval[this.attribute] = n;
                this.$emit('new-eval', JSON.stringify(eval));
            }
        },
        template: `<div class="likert">
                    <span class="left-pole pole">{{ left }}</span>
                    <input type="radio" :name="attribute" value="1" class="choice" v-model="selected"/>
                    <input type="radio" :name="attribute" value="2" class="choice" v-model="selected"/>
                    <input type="radio" :name="attribute" value="3" class="choice" v-model="selected"/>
                    <input type="radio" :name="attribute" value="4" class="choice" v-model="selected"/>
                    <input type="radio" :name="attribute" value="5" class="choice" v-model="selected"/>
                    <input type="radio" :name="attribute" value="6" class="choice" v-model="selected"/>
                    <input type="radio" :name="attribute" value="7" class="choice" v-model="selected"/>
                    <span class="right-pole pole">{{ right }}</span>
                </div>`
    });

    var research = new Vue({
        el: '#app',
        data: {
            message: {},
            current: 1,
            estimated: '',
            german: {
                intro: 'Einführung',
                introThanks: 'Vielen Dank, dass Sie sich die Zeit nehmen, an diesem Experiment teilzunehmen. Die Durchführung dauert etwa 15 Minuten.',
                following: 'Auf der folgenden Seite werden zunächst einige allgemeine Informationen abgefragt. Um am Experiment teilzunehmen, müssen Sie zunächst zustimmen, dass Sie sich damit einverstanden erklären, dass die gemachten Angaben zu Forschungszwecken verwendet und für spätere Referenz gespeichert werden.',
                protection: 'The gesammelten Daten sind anonym und in keiner Weise mit Ihrer Person in Verbindung zu bringen, sie dienen einzig als Mittel, um auszuwerten, wie die Antworten sich für bestimmte Personengruppen unterscheiden. Während der Durchführung des Experiments (etwa 4 Wochen) werden die Daten auf einem Server in der EU und danach auf dem Gerät des Erstellers gespeichert.',
                consent: 'Ich willige ein, dass die von mir im folgenden Experiment erhobenen Antworten für akademische Zwecke genutzt und anschließend aufgewahrt werden dürfen',
                basic: 'Angaben zum Probanden',
                age: 'Wie alt sind Sie?',
                primary: 'Was ist Ihre Primärsprache?',
                profession: 'Was ist Ihr Beruf?',
                contact: 'Wie viel Kontakt haben Sie im Alltag mit Fremdsprachen?',
                basicIntro: '',
                experimentIntro: 'Auf den folgenden Seiten werden Sie Aufnahmen kurzer englischer Sätze hören. Bitte bewerten Sie diese Aufnahmen mithilfe der zur Verfügung gestellten Skalen. Sie können sie so oft sie wollen abspielen und zur nächsten Seite fortfahren, sobald Sie ihre Bewertung abgegeben haben.',
                listen: 'Bitte hören Sie sich die folgende Aufnahme an',
                proficiency: 'Wie schätzen Sie das Sprachniveau des Sprechers ein?',
                beginner: 'Anfänger',
                native: 'Muttersprachler',
                sound: 'Wie klingt der Sprecher für Sie?',
                conclusion: 'Abschließend',
                conclusionThanks: 'Vielen Dank, dass Sie an dem Experiment teilgenommen haben, Ihre Antworten wurden übermittelt.',
                concludingQuestion: 'Bitte geben Sie an, wie viele Sprecher Sie in den vorausgegangenen x Aufnahmen gehört haben:',
                submit: 'Abschicken',
                disclosure: 'Aufklärung'
            },

            english: {
                intro: 'Introduction',
                introThanks: 'Thanks for taking the time to participate in this experiment. Completing it takes about 15 minutes.',
                following: 'In the following slides, you will first be asked to provide some basic information. To take the experiment, you will have to consent to your data being used for research purposes and stored for later reference.',
                protection: 'The collected data is anonymized and not in any way assignable to you personally, it serves solely as a means to spot how answers vary across different demographics. It is stored on a server in the EU for the time of this experiment (about 4 weeks), and on the researcher\'s personal device afterwards.',
                consent: 'I give my consent that the answers I give in the following experiment may be used for academic purposes and stored afterwards',
                basic: 'Participant\'s basic information',
                age: 'What is your age?',
                primary: 'What is your primary language?',
                profession: 'What is your profession?',
                contact: 'How much contact to you have with foreign langugages on a daily basis?',
                basicIntro: '',
                experimentIntro: 'On the following slides, you will hear several recordings of short English sentences. Please rate the recordings according to the provided scales. You can replay them as often as you like and will be able to proceed to the next slide as soon as you have given your ratings. ',
                listen: 'Please listen to the following recording',
                proficiency: 'How would you rate the proficiency of this speaker?',
                beginner: 'Beginner',
                native: 'Native',
                sound: 'How does the speaker sound to you?',
                conclusion: 'Conclusion',
                conclusionThanks: 'Thanks for having completed the experiment, your answers have been recorded.',
                concludingQuestion: 'Please indicate below how many different speakers you have heard in the preceding x recordings:',
                submit: 'Submit',
                disclosure: 'Disclosure'
            },
            language: null,
            $nextArrow: null,
            validators: [
                function () {
                    //User needs to consent to the usage of their data
                    let box = document.querySelectorAll('.vueperslide--active')[0].querySelector('input[type=checkbox]');
                    return box.checked;
                },
                function () {
                    //All fields need to be filled or ticked for the form to be valid
                    let value = true;
                    let inputs = document.querySelectorAll('.vueperslide--active')[0].querySelectorAll('input[type=text]');

                    let matchers = { primary: /^[\w\s]+$/, age: /^\d{2}$/, profession: /^[\w\s]+$/, contact: /^\d{2}$/ }
                    for (input of inputs) {
                        if (!matchers[input.id].test(input.value)) {
                            value = false
                        }
                    }
                    return value;
                },
                function () {
                    //No validation needed for this explanatory slide
                    return true
                },
                function () {
                    //No validation needed for this explanatory slide
                    return true
                },
                function () {
                    //No validation needed for this explanatory slide
                    return true
                },
                function () {
                    //No validation needed for this explanatory slide
                    return true
                },
                function () {
                    //No validation needed for this explanatory slide
                    return true
                },
                function () {
                    //No validation needed for this explanatory slide
                    return true
                },
                function () {
                    //No validation needed for this explanatory slide
                    return true
                },
                function () {
                    //No validation needed for this explanatory slide
                    return true
                },
                function () {
                    //No validation needed for this explanatory slide
                    return true
                },
                function () {
                    //No validation needed for this explanatory slide
                    return true
                },
                function () {
                    //No validation needed for this explanatory slide
                    return true
                },
                function () {
                    //No validation needed for this explanatory slide
                    return true
                },
                function () {
                    //No validation needed for this explanatory slide
                    return true
                },
                function () {
                    //No validation needed for this explanatory slide
                    return true
                },
                function () {
                    //No validation needed for this explanatory slide
                    return false
                }
            ]
        },
        methods: {
            postMessage: function () {
                fetch('/api/store', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: `{'message' : '${this.message}'}`
                })
            },
            toGerman: function () {
                this.language = this.german;
            },
            toEnglish: function () {
                this.language = this.english;
            },
            wrapArrow: function () {
                this.$nextArrow = document.querySelectorAll('.vueperslides__arrow--next')[0];
                document.querySelectorAll('.vueperslides__arrow--prev')[0].remove();
                this.$nextArrow.style.display = 'none'
            },
            nextSlide: function (e) {
                this.current = e.currentSlide.index;
                this.$nextArrow.style.display = 'none';
                this.$nextArrow.style.display = 'none'
                setTimeout(() => { this.validate() }, 1500)
            },
            validate: function () {
                console.log('Validating...');
                let value = this.validators[this.current]();
                this.$nextArrow.style.display = value ? '' : 'none';
            },
            hasEstimated: function () {
                return /^\d{1,2}$/.test(this.estimated);
            },
            submit: function () {
                this.$refs.slides.next();
                console.log(this.message);
            },
            updatePersonal: function (e) {
                this.message['personal'] = JSON.parse(e);
            },
            updateEvals: function (e) {
                let evaluation = JSON.parse(e);

                for (key in evaluation) {
                    let parts = key.split('-');
                    console.log(parts)
                    if (!this.message[`recording-${parts[1]}`]) {
                        this.message[`recording-${parts[1]}`] = {};
                    }
                    this.message[`recording-${parts[1]}`][parts[0]] = evaluation[key];
                }
                console.log(this.message);
            },
            updateEstimation: function(e) {
                let estimation = JSON.parse(e);

                for (key in estimation){
                    this.estimated = estimation[key];
                    this.message[key] = estimation[key];
                }
                console.log(this.message);
            }
        },
        created: function () {
            this.language = this.english;
        }
    });

</script>

</html>

<!--
TODOS
---

/  Input für abschließende Frage
   Alle Angaben auf Deutsch/Englisch
/  Verschiedene Quellen für die audio-Elemente
   Erklärungen vervollständigen
   Validierung der Bewertungen
   Datenstruktur zum Senden der Daten 

 -->